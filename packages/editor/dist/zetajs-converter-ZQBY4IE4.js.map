{"version":3,"sources":["../src/utils/pdf/zetajs-converter.ts"],"names":[],"mappings":"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","file":"zetajs-converter-ZQBY4IE4.js","sourcesContent":["/**\n * ZetaJS PDF Converter\n * \n * This module handles the conversion of DOCX files to PDF using\n * LibreOffice WebAssembly (LOWA) via the zetajs library.\n * \n * The conversion happens entirely client-side using Web Workers.\n * All helper files are bundled and lazy-loaded on first use.\n */\n\n// ZetaOffice CDN URL for LOWA files (WASM binaries)\nconst ZETAOFFICE_CDN_URL = \"https://cdn.zetaoffice.net/zetaoffice_latest/\";\n\n// Type definitions for Emscripten FS (not fully typed)\ninterface EmscriptenFS {\n  readFile: (path: string) => Uint8Array;\n  writeFile: (path: string, data: Uint8Array) => void;\n  unlink: (path: string) => void;\n  mkdir: (path: string) => void;\n}\n\n// Type for worker messages\ninterface WorkerMessageData {\n  cmd: string;\n  name?: string;\n  from?: string;\n  to?: string;\n  error?: string;\n}\n\n// Singleton instance for the converter\nlet converterInstance: ZetaJSConverter | null = null;\n\n// Track initialization state\nlet isInitializing = false;\nlet initPromise: Promise<void> | null = null;\n\n// Store for FS and thrPort after initialization\nlet FS: EmscriptenFS | null = null;\nlet thrPort: MessagePort | null = null;\n\n// Cached blob URLs for helper scripts (lazy loaded)\nlet zetaJsBlobUrl: string | null = null;\nlet zetaHelperJsBlobUrl: string | null = null;\n\n// Pending conversions map\nconst pendingConversions = new Map<string, {\n  resolve: (blob: Blob) => void;\n  reject: (error: Error) => void;\n  outputPath: string;\n  inputPath: string;\n}>();\n\n/**\n * Lazy load the embedded zetajs helper files and create blob URLs\n * This adds ~56KB to the download only when PDF export is first used\n */\nasync function loadZetaJsHelpers(): Promise<{ zetaJsUrl: string; zetaHelperJsUrl: string }> {\n  if (zetaJsBlobUrl && zetaHelperJsBlobUrl) {\n    return { zetaJsUrl: zetaJsBlobUrl, zetaHelperJsUrl: zetaHelperJsBlobUrl };\n  }\n\n  // Dynamic import - only loads when needed\n  const { createZetaJsBlobUrl, createZetaHelperJsBlobUrl } = await import(\"./zetajs-embedded\");\n  \n  zetaJsBlobUrl = createZetaJsBlobUrl();\n  zetaHelperJsBlobUrl = createZetaHelperJsBlobUrl();\n  \n  return { zetaJsUrl: zetaJsBlobUrl, zetaHelperJsUrl: zetaHelperJsBlobUrl };\n}\n\n/**\n * Create the worker script that runs inside the LibreOffice thread\n * This script handles the actual document conversion\n */\nfunction createWorkerScript(): string {\n  return `\n// Worker script for ZetaJS PDF conversion\n// This runs inside the LibreOffice WASM thread AFTER zetajs is ready\n\n// Access zetajs from the global store (set by zetaHelperWrapThread)\nconst zetajs = globalThis.zetajsStore.zetajs;\nconst css = zetajs.uno.com.sun.star;\nconst thrPort = zetajs.mainPort;\n\n// Create property beans for conversion\nconst bean_hidden = new css.beans.PropertyValue({Name: 'Hidden', Value: true});\nconst bean_overwrite = new css.beans.PropertyValue({Name: 'Overwrite', Value: true});\nconst bean_pdf_export = new css.beans.PropertyValue({Name: 'FilterName', Value: 'writer_pdf_Export'});\n\n// Get desktop for document operations\nconst context = zetajs.getUnoComponentContext();\nconst desktop = css.frame.Desktop.create(context);\n\nlet xModel;\n\nthrPort.onmessage = (e) => {\n  switch (e.data.cmd) {\n    case 'convert':\n      try {\n        // Close previous document if exists\n        if (xModel !== undefined) {\n          try {\n            if (xModel.queryInterface(zetajs.type.interface(css.util.XCloseable))) {\n              xModel.close(false);\n            }\n          } catch (closeErr) {\n            // Silently ignore close errors\n          }\n        }\n        \n        const from = e.data.from;\n        const to = e.data.to;\n        \n        // Load document (hidden)\n        xModel = desktop.loadComponentFromURL('file://' + from, '_blank', 0, [bean_hidden]);\n        \n        // Export to PDF\n        xModel.storeToURL('file://' + to, [bean_overwrite, bean_pdf_export]);\n        \n        // Send the path back to main thread - it will read the file\n        zetajs.mainPort.postMessage({\n          cmd: 'converted',\n          name: e.data.name,\n          from: from,\n          to: to\n        });\n        \n      } catch (err) {\n        console.error('[ZetaJS] Conversion error:', err);\n        zetajs.mainPort.postMessage({\n          cmd: 'error',\n          name: e.data.name,\n          error: err.message || 'Unknown conversion error'\n        });\n      }\n      break;\n    default:\n      break;\n  }\n};\n\n// Signal that worker is ready\nthrPort.postMessage({ cmd: 'worker_ready' });\n`;\n}\n\n/**\n * Initialize the LibreOffice WASM environment\n */\nasync function initializeZetaJS(): Promise<void> {\n  if (FS && thrPort) {\n    return; // Already initialized\n  }\n  \n  if (initPromise) {\n    return initPromise;\n  }\n  \n  if (typeof window === \"undefined\") {\n    throw new Error(\"ZetaJS can only be initialized in a browser environment\");\n  }\n  \n  isInitializing = true;\n  \n  initPromise = new Promise<void>(async (resolve, reject) => {\n    try {\n      // Lazy load helper scripts\n      const { zetaJsUrl, zetaHelperJsUrl } = await loadZetaJsHelpers();\n      \n      // Create hidden canvas element (required by zetajs)\n      let canvas = document.getElementById(\"qtcanvas\") as HTMLCanvasElement;\n      if (!canvas) {\n        canvas = document.createElement(\"canvas\");\n        canvas.id = \"qtcanvas\";\n        canvas.style.display = \"none\";\n        document.body.appendChild(canvas);\n      }\n      \n      // Create worker script as blob URL\n      const workerScript = createWorkerScript();\n      const workerBlob = new Blob([workerScript], { type: \"application/javascript\" });\n      const workerUrl = URL.createObjectURL(workerBlob);\n      \n      // Set up Module configuration\n      const soffice_base_url = ZETAOFFICE_CDN_URL;\n      \n      // Create the wrapper script that initializes zetajsStore in the worker\n      const threadWrapScript = `data:text/javascript;charset=UTF-8,` +\n        `import(\"${zetaHelperJsUrl}\").then(m => {m.zetaHelperWrapThread();});`;\n      \n      // Emscripten Module configuration\n      const Module: Record<string, unknown> = {\n        canvas,\n        uno_scripts: [zetaJsUrl, threadWrapScript],\n        locateFile: (path: string, prefix: string) => {\n          return (prefix || soffice_base_url) + path;\n        },\n      };\n      \n      // Create the main script blob for the worker\n      Module.mainScriptUrlOrBlob = new Blob(\n        [`importScripts('${soffice_base_url}soffice.js');`],\n        { type: \"text/javascript\" }\n      );\n      \n      // Set Module as global (required by soffice.js)\n      (window as unknown as Record<string, unknown>).Module = Module;\n      \n      // Load soffice.js\n      const sofficeScript = document.createElement(\"script\");\n      sofficeScript.src = `${soffice_base_url}soffice.js`;\n      \n      sofficeScript.onerror = () => {\n        isInitializing = false;\n        initPromise = null;\n        reject(new Error(\"Failed to load LibreOffice WASM\"));\n      };\n      \n      sofficeScript.onload = () => {\n        // Wait for Module.uno_main to be available\n        const checkReady = setInterval(() => {\n          if (Module.uno_main) {\n            clearInterval(checkReady);\n            \n            (Module.uno_main as Promise<MessagePort>).then((port: MessagePort) => {\n              thrPort = port;\n              FS = (window as unknown as Record<string, unknown>).FS as EmscriptenFS;\n              \n              // Set up message handler\n              thrPort!.onmessage = (e: MessageEvent) => {\n                const data = e.data as WorkerMessageData;\n                \n                switch (data.cmd) {\n                  case \"ZetaHelper::thr_started\":\n                    thrPort!.postMessage({\n                      cmd: \"ZetaHelper::run_thr_script\",\n                      threadJs: workerUrl,\n                      threadJsType: \"classic\"\n                    });\n                    break;\n                    \n                  case \"worker_ready\":\n                    isInitializing = false;\n                    resolve();\n                    break;\n                    \n                  default:\n                    handleWorkerMessage(data);\n                }\n              };\n              \n            }).catch((err: Error) => {\n              isInitializing = false;\n              initPromise = null;\n              reject(new Error(`WASM initialization failed: ${err.message}`));\n            });\n          }\n        }, 100);\n        \n        // Timeout after 120 seconds\n        setTimeout(() => {\n          clearInterval(checkReady);\n          if (isInitializing) {\n            isInitializing = false;\n            initPromise = null;\n            reject(new Error(\"LibreOffice WASM initialization timed out\"));\n          }\n        }, 120000);\n      };\n      \n      document.body.appendChild(sofficeScript);\n      \n    } catch (error) {\n      isInitializing = false;\n      initPromise = null;\n      reject(error);\n    }\n  });\n  \n  return initPromise;\n}\n\n/**\n * Handle messages from the worker thread\n */\nfunction handleWorkerMessage(data: WorkerMessageData): void {\n  switch (data.cmd) {\n    case \"ZetaHelper::thr_started\":\n    case \"worker_ready\":\n      break;\n      \n    case \"converted\": {\n      if (!data.name || !data.to) break;\n      const conversion = pendingConversions.get(data.name);\n      if (conversion) {\n        try {\n          const mainFS = (window as unknown as Record<string, unknown>).FS as EmscriptenFS;\n          const pdfData = mainFS.readFile(data.to);\n          const blob = new Blob([new Uint8Array(pdfData)], { type: \"application/pdf\" });\n          \n          // Clean up virtual filesystem\n          try { mainFS.unlink(conversion.inputPath); } catch { /* ignore */ }\n          try { mainFS.unlink(data.to); } catch { /* ignore */ }\n          \n          conversion.resolve(blob);\n        } catch (error) {\n          conversion.reject(new Error(`Failed to read PDF from FS: ${error}`));\n        }\n        pendingConversions.delete(data.name);\n      }\n      break;\n    }\n    \n    case \"error\": {\n      if (!data.name) break;\n      const conversion = pendingConversions.get(data.name);\n      if (conversion) {\n        conversion.reject(new Error(data.error || \"Conversion failed\"));\n        pendingConversions.delete(data.name);\n        \n        try {\n          FS!.unlink(conversion.inputPath);\n        } catch { /* ignore */ }\n      }\n      break;\n    }\n    \n    default:\n      break;\n  }\n}\n\n/**\n * ZetaJS Converter class\n * Manages LibreOffice WASM initialization and document conversion\n */\nexport class ZetaJSConverter {\n  private initPromise: Promise<void> | null = null;\n  \n  /**\n   * Initialize the LibreOffice WASM environment\n   * This is lazy-loaded and only happens on first use\n   */\n  async initialize(): Promise<void> {\n    if (this.initPromise) {\n      return this.initPromise;\n    }\n    \n    this.initPromise = initializeZetaJS();\n    return this.initPromise;\n  }\n  \n  /**\n   * Check if the converter is initialized\n   */\n  isReady(): boolean {\n    return FS !== null && thrPort !== null;\n  }\n  \n  /**\n   * Convert a DOCX blob to PDF\n   */\n  async convertDocxToPdf(docxBlob: Blob, filename: string = \"document\"): Promise<Blob> {\n    await this.initialize();\n    \n    if (!FS || !thrPort) {\n      throw new Error(\"ZetaJS not initialized\");\n    }\n    \n    return new Promise((resolve, reject) => {\n      const conversionId = `${filename.replace(/[^a-zA-Z0-9]/g, \"_\")}_${Date.now()}`;\n      const inputPath = `/tmp/input_${conversionId}.docx`;\n      const outputPath = `/tmp/output_${conversionId}.pdf`;\n      \n      pendingConversions.set(conversionId, { \n        resolve, \n        reject,\n        inputPath,\n        outputPath\n      });\n      \n      docxBlob.arrayBuffer().then((data) => {\n        try {\n          try {\n            FS!.mkdir(\"/tmp\");\n          } catch { /* Directory may exist */ }\n          \n          FS!.writeFile(inputPath, new Uint8Array(data));\n          \n          thrPort!.postMessage({\n            cmd: \"convert\",\n            name: conversionId,\n            from: inputPath,\n            to: outputPath,\n          });\n        } catch (error) {\n          pendingConversions.delete(conversionId);\n          reject(new Error(`Failed to prepare DOCX for conversion: ${error}`));\n        }\n      }).catch((error) => {\n        pendingConversions.delete(conversionId);\n        reject(new Error(`Failed to read DOCX blob: ${error}`));\n      });\n      \n      // Timeout after 120 seconds\n      setTimeout(() => {\n        if (pendingConversions.has(conversionId)) {\n          pendingConversions.delete(conversionId);\n          reject(new Error(\"PDF conversion timed out after 120 seconds\"));\n        }\n      }, 120000);\n    });\n  }\n}\n\n/**\n * Get or create the singleton converter instance\n */\nexport function getConverter(): ZetaJSConverter {\n  if (!converterInstance) {\n    converterInstance = new ZetaJSConverter();\n  }\n  return converterInstance;\n}\n\n/**\n * Convert a DOCX blob to PDF using zetajs\n */\nexport async function convertDocxToPdf(docxBlob: Blob, filename?: string): Promise<Blob> {\n  const converter = getConverter();\n  return converter.convertDocxToPdf(docxBlob, filename);\n}\n\n/**\n * Pre-initialize the converter (optional, for eager loading)\n */\nexport async function preInitialize(): Promise<void> {\n  const converter = getConverter();\n  return converter.initialize();\n}\n\n"]}